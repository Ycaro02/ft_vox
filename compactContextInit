
s8 contextTextureInit(Context *context) {

	/* Init skybox */
	context->skyboxVAO = skyboxInit();
	context->skyboxShaderID = load_shader(SKY_VERTEX_SHADER, SKY_FRAGMENT_SHADER);
	context->skyTexture = load_cubemap(TEXTURE_SKY_PATH, 1024, 1024);
	if (!context->skyTexture) {
		ft_printf_fd(2, "Error: load_cubemap failed\n");
		return (FALSE);
	}
	set_shader_texture(context->skyboxShaderID, context->skyTexture, GL_TEXTURE_CUBE_MAP, "texture1");

	/* Init cube */
	context->cubeShaderID = load_shader(CUBE_VERTEX_SHADER, CUBE_FRAGMENT_SHADER);
    GLuint textureAtlas = load_texture_atlas(TEXTURE_ATLAS_PATH, 16, 16);
	if (!textureAtlas) {
		ft_printf_fd(2, "Error: load_texture_atlas failed\n");
		return (FALSE);
	}
	set_shader_texture(context->cubeShaderID, textureAtlas, GL_TEXTURE_3D, "textureAtlas");
	return (TRUE);
}

f32 **perlin2DInit(u32 seed) {
	f32 **perlin2D = NULL;
	u8 *perlin1D = perlinNoiseGeneration(seed); /* seed 42 */
	if (!perlin1D) {
		ft_printf_fd(1, "Error: perlinNoise error\n");
		return (NULL);
	}
	/* Transform 1D array to 2D array */
	perlin2D = array1DTo2D(perlin1D, PERLIN_NOISE_HEIGHT, PERLIN_NOISE_WIDTH);
	free(perlin1D);
	return (perlin2D);
}

Context *contextInit() {
	Context *context;


	if (!(context = ft_calloc(sizeof(Context), 1))) {
		return (NULL);
	} else if (!(context->world = ft_calloc(sizeof(World), 1))) {
		return (NULL);
	} else if (!(context->win_ptr = init_openGL_context())) {
		return (NULL);
	} else if (!(context->world = ft_calloc(sizeof(World), 1))) {
		return (NULL);
	} else if (!(context->cubeVAO = setupCubeVAO(&context->cube))) {
		return (NULL);
	} else if (!(context->world->chunksMap = hashmap_init(HASHMAP_SIZE_2000, chunksMapFree))) {
		return (NULL);
	} else if (!(context->perlin2D = perlin2DInit(42U))) {
		return (NULL);
	} else if (!(context->world->renderChunksMap = hashmap_init(HASHMAP_SIZE_2000, hashmap_free_node_only))) {
		return (NULL);
	} else if (!threadSupervisorInit(context)) {
		ft_printf_fd(2, "Error: threadSupervisorInit failed\n");
		return (NULL);
	} else if (!contextTextureInit(context)) {
		ft_printf_fd(2, "Error: contextTextureInit failed\n");
		return (NULL);
	}

	/* init context camera */
	context->cam = create_camera(CAM_FOV, CAM_ASPECT_RATIO(SCREEN_WIDTH, SCREEN_HEIGHT), CAM_NEAR, CAM_FAR);
    glm_mat4_identity(context->cube.rotation);

	context->isPlaying = TRUE;
	// mtx_init(&context->renderMtx, mtx_plain);
	return (context);
}

int main() {
    Context *context;

	if (!(context = contextInit())) {
		ft_printf_fd(2, "Error: contextInit failed\n");
		return (1);
	}

	/* Disable VSync to avoid fps locking */
	// glfwSwapInterval(0);

	main_loop(context, context->cubeVAO, context->skyTexture);

    vox_destroy(context);
    return (0);
}


